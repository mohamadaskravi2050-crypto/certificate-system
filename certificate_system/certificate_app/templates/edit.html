{% extends 'base.html' %}

{% block title %}Edit PDF - Certificate System{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Edit Text Boxes - <span id="pdfTitle">Loading...</span></h1>
        <div class="header-actions">
            <button id="saveBoxes" class="btn btn-primary">Save All Boxes</button>
            <button id="addBox" class="btn btn-secondary">Add New Text Box</button>
            <button id="clearAll" class="btn btn-danger">Clear All Boxes</button>
            <a href="/" class="btn btn-outline">Back to Home</a>
        </div>
    </div>

    <div class="edit-container">
        <!-- PDF Viewer Section -->
        <div class="pdf-viewer-container">
            <div class="viewer-controls">
                <div class="zoom-controls">
                    <button id="zoomOut" class="btn btn-small">-</button>
                    <span id="zoomLevel">100%</span>
                    <button id="zoomIn" class="btn btn-small">+</button>
                </div>
                <div class="drawing-mode">
                    <label>
                        <input type="checkbox" id="drawingMode"> Drawing Mode
                    </label>
                </div>
            </div>
            <div class="pdf-viewer-wrapper">
                <div id="pdfContainer" class="pdf-container">
                    <div id="pdfDisplay">
                        <!-- PDF will be rendered here -->
                        <iframe id="pdfFrame" width="100%" height="600" style="border: 1px solid #ccc;"></iframe>
                    </div>
                    <div id="boxesOverlay" class="boxes-overlay"></div>
                    <div id="drawingOverlay" class="drawing-overlay" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="panel-section">
                <h3>Text Boxes <span id="boxesCount">(0)</span></h3>
                <div id="boxesList" class="boxes-list">
                    <div class="no-boxes">No text boxes yet. Add one to get started!</div>
                </div>
            </div>
            
            <div class="panel-section box-editor" id="boxEditor" style="display: none;">
                <h4>Edit Text Box</h4>
                <form id="boxEditForm" class="box-form">
                    <input type="hidden" id="boxId">
                    
                    <div class="form-group">
                        <label for="boxName">Field Name:</label>
                        <input type="text" id="boxName" class="text-input" placeholder="e.g., name, date, signature" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="boxX">X Position:</label>
                            <input type="number" id="boxX" class="number-input" step="1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="boxY">Y Position:</label>
                            <input type="number" id="boxY" class="number-input" step="1" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="boxWidth">Width:</label>
                            <input type="number" id="boxWidth" class="number-input" step="1" min="20" required>
                        </div>
                        <div class="form-group">
                            <label for="boxHeight">Height:</label>
                            <input type="number" id="boxHeight" class="number-input" step="1" min="10" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="boxFontSize">Font Size:</label>
                            <input type="number" id="boxFontSize" class="number-input" value="12" min="8" max="72" required>
                        </div>
                        <div class="form-group">
                            <label for="boxFontFamily">Font:</label>
                            <select id="boxFontFamily" class="select-input">
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times-Roman">Times Roman</option>
                                <option value="Courier">Courier</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" id="deleteBox" class="btn btn-danger">Delete Box</button>
                        <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Edit Page Specific Styles */
.edit-container {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 20px;
    margin-top: 20px;
}

.pdf-viewer-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
}

.viewer-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: white;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.zoom-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.drawing-mode label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    cursor: pointer;
}

.pdf-viewer-wrapper {
    position: relative;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
}

.pdf-container {
    position: relative;
    width: 100%;
}

#pdfFrame {
    width: 100%;
    height: 800px;
    border: none;
    background: white;
}

.boxes-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
}

.text-box {
    position: absolute;
    border: 2px solid #007bff;
    background: rgba(0, 123, 255, 0.1);
    cursor: move;
    pointer-events: all;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

.text-box:hover {
    background: rgba(0, 123, 255, 0.2);
    border-color: #0056b3;
}

.text-box.selected {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.2);
    z-index: 20;
}

.text-box-label {
    position: absolute;
    top: -25px;
    left: 0;
    background: #007bff;
    color: white;
    padding: 2px 6px;
    font-size: 11px;
    border-radius: 3px;
    white-space: nowrap;
    pointer-events: none;
}

.text-box.selected .text-box-label {
    background: #28a745;
}

.text-box-handle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #007bff;
    border: 1px solid white;
    border-radius: 50%;
    pointer-events: all;
}

.text-box.selected .text-box-handle {
    background: #28a745;
}

.handle-nw { top: -4px; left: -4px; cursor: nw-resize; }
.handle-ne { top: -4px; right: -4px; cursor: ne-resize; }
.handle-sw { bottom: -4px; left: -4px; cursor: sw-resize; }
.handle-se { bottom: -4px; right: -4px; cursor: se-resize; }

.controls-panel {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.panel-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.panel-section h3 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 1.2rem;
}

.panel-section h4 {
    margin: 0 0 15px 0;
    color: #2c3e50;
}

.boxes-list {
    max-height: 300px;
    overflow-y: auto;
}

.box-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.box-item:hover {
    background: #e9ecef;
    border-color: #007bff;
}

.box-item.selected {
    background: #d4edda;
    border-color: #28a745;
}

.box-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.box-item-name {
    font-weight: bold;
    color: #2c3e50;
}

.box-item-delete {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 3px;
    padding: 2px 6px;
    font-size: 12px;
    cursor: pointer;
}

.box-item-delete:hover {
    background: #c82333;
}

.box-item-details {
    font-size: 12px;
    color: #6c757d;
}

.box-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.form-actions .btn {
    flex: 1;
}

.select-input {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #bdc3c7;
    border-radius: 4px;
    font-size: 14px;
    background: white;
}

.select-input:focus {
    outline: none;
    border-color: #3498db;
}

.drawing-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.1);
    cursor: crosshair;
    z-index: 5;
}

.drawing-preview {
    position: absolute;
    border: 2px dashed #007bff;
    background: rgba(0, 123, 255, 0.1);
}

.no-boxes {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 20px;
}

/* Responsive */
@media (max-width: 1024px) {
    .edit-container {
        grid-template-columns: 1fr;
    }
    
    .controls-panel {
        order: -1;
    }
    
    #pdfFrame {
        height: 600px;
    }
}

@media (max-width: 768px) {
    .header-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .header-actions .btn {
        width: 100%;
    }
    
    #pdfFrame {
        height: 400px;
    }
}
</style>

<script>
// Global variables
let currentPdfId = null;
let textBoxes = [];
let currentZoom = 100;
let isDrawing = false;
let isDragging = false;
let isResizing = false;
let currentBox = null;
let selectedBox = null;
let startX, startY;
let pdfData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Get PDF ID from URL
    const pathParts = window.location.pathname.split('/');
    currentPdfId = parseInt(pathParts[pathParts.length - 2]);
    
    if (currentPdfId) {
        loadPDFData();
        setupEventListeners();
    }
});

async function loadPDFData() {
    try {
        showLoading('Loading PDF...');
        
        const response = await fetch(`/api/edit/${currentPdfId}/`);
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('pdfTitle').textContent = data.pdf_name;
            pdfData = data;
            
            // Display PDF in iframe
            const pdfFrame = document.getElementById('pdfFrame');
            pdfFrame.src = data.pdf_data;
            
            textBoxes = data.text_boxes;
            updateBoxesList();
            renderTextBoxes();
            
            hideLoading();
        } else {
            hideLoading();
            alert('Error loading PDF data: ' + data.error);
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        alert('Error loading PDF data');
    }
}

function showLoading(message) {
    document.getElementById('pdfDisplay').innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 600px; background: #f8f9fa;">
            <div style="text-align: center;">
                <div style="font-size: 16px; color: #666; margin-bottom: 10px;">${message}</div>
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
    `;
}

function hideLoading() {
    // PDF frame will be shown automatically when loaded
}

function setupEventListeners() {
    // Save boxes button
    document.getElementById('saveBoxes').addEventListener('click', saveBoxes);
    
    // Add box button
    document.getElementById('addBox').addEventListener('click', startAddBox);
    
    // Clear all button
    document.getElementById('clearAll').addEventListener('click', clearAllBoxes);
    
    // Drawing mode toggle
    document.getElementById('drawingMode').addEventListener('change', toggleDrawingMode);
    
    // Zoom controls
    document.getElementById('zoomIn').addEventListener('click', () => adjustZoom(10));
    document.getElementById('zoomOut').addEventListener('click', () => adjustZoom(-10));
    
    // Box form
    document.getElementById('boxEditForm').addEventListener('submit', saveBox);
    document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
    document.getElementById('deleteBox').addEventListener('click', deleteCurrentBox);
    
    // Real-time updates from form inputs
    document.getElementById('boxX').addEventListener('input', updateSelectedBoxPosition);
    document.getElementById('boxY').addEventListener('input', updateSelectedBoxPosition);
    document.getElementById('boxWidth').addEventListener('input', updateSelectedBoxSize);
    document.getElementById('boxHeight').addEventListener('input', updateSelectedBoxSize);
}

function startAddBox() {
    const drawingMode = document.getElementById('drawingMode');
    drawingMode.checked = true;
    toggleDrawingMode();
}

function toggleDrawingMode() {
    const drawingMode = document.getElementById('drawingMode').checked;
    const drawingOverlay = document.getElementById('drawingOverlay');
    
    if (drawingMode) {
        drawingOverlay.style.display = 'block';
        setupDrawingMode();
    } else {
        drawingOverlay.style.display = 'none';
        cleanupDrawingMode();
    }
}

function setupDrawingMode() {
    const drawingOverlay = document.getElementById('drawingOverlay');
    const pdfFrame = document.getElementById('pdfFrame');
    
    // Set drawing overlay size to match PDF frame
    drawingOverlay.style.width = pdfFrame.offsetWidth + 'px';
    drawingOverlay.style.height = pdfFrame.offsetHeight + 'px';
    
    drawingOverlay.onmousedown = function(e) {
        if (!isDrawing) {
            startDrawing(e);
        }
    };
}

function cleanupDrawingMode() {
    const drawingOverlay = document.getElementById('drawingOverlay');
    drawingOverlay.onmousedown = null;
    drawingOverlay.onmousemove = null;
    drawingOverlay.onmouseup = null;
}

function startDrawing(e) {
    isDrawing = true;
    const rect = e.target.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    
    // Create preview box
    currentBox = document.createElement('div');
    currentBox.className = 'drawing-preview';
    currentBox.style.left = startX + 'px';
    currentBox.style.top = startY + 'px';
    currentBox.style.width = '0px';
    currentBox.style.height = '0px';
    
    document.getElementById('drawingOverlay').appendChild(currentBox);
    
    // Add mouse move and up listeners
    document.addEventListener('mousemove', drawBox);
    document.addEventListener('mouseup', finishDrawing);
}

function drawBox(e) {
    if (!isDrawing) return;
    
    const rect = document.getElementById('drawingOverlay').getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    const width = Math.abs(currentX - startX);
    const height = Math.abs(currentY - startY);
    const left = Math.min(currentX, startX);
    const top = Math.min(currentY, startY);
    
    currentBox.style.left = left + 'px';
    currentBox.style.top = top + 'px';
    currentBox.style.width = width + 'px';
    currentBox.style.height = height + 'px';
}

function finishDrawing(e) {
    if (!isDrawing) return;
    
    isDrawing = false;
    const rect = document.getElementById('drawingOverlay').getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    const width = Math.abs(currentX - startX);
    const height = Math.abs(currentY - startY);
    
    if (width > 20 && height > 10) {
        const x = Math.min(currentX, startX);
        const y = Math.min(currentY, startY);
        createNewBox(x, y, width, height);
    }
    
    // Cleanup
    if (currentBox && currentBox.parentNode) {
        currentBox.parentNode.removeChild(currentBox);
    }
    currentBox = null;
    
    document.removeEventListener('mousemove', drawBox);
    document.removeEventListener('mouseup', finishDrawing);
    
    // Turn off drawing mode
    document.getElementById('drawingMode').checked = false;
    document.getElementById('drawingOverlay').style.display = 'none';
}

function createNewBox(x, y, width, height) {
    const boxNumber = textBoxes.length + 1;
    const newBox = {
        id: 'new-' + Date.now(),
        name: `field_${boxNumber}`,
        x: x,
        y: y,
        width: width,
        height: height,
        page: 1,
        font_size: 12,
        font_family: 'Helvetica'
    };
    
    textBoxes.push(newBox);
    updateBoxesList();
    renderTextBoxes();
    selectBox(newBox);
}

function renderTextBoxes() {
    const overlay = document.getElementById('boxesOverlay');
    overlay.innerHTML = '';
    
    textBoxes.forEach(box => {
        const boxElement = createBoxElement(box);
        overlay.appendChild(boxElement);
    });
    
    updateBoxesCount();
}

function createBoxElement(box) {
    const boxElement = document.createElement('div');
    boxElement.className = 'text-box';
    if (selectedBox && selectedBox.id === box.id) {
        boxElement.classList.add('selected');
    }
    
    boxElement.style.left = box.x + 'px';
    boxElement.style.top = box.y + 'px';
    boxElement.style.width = box.width + 'px';
    boxElement.style.height = box.height + 'px';
    
    // Label
    const label = document.createElement('div');
    label.className = 'text-box-label';
    label.textContent = box.name;
    boxElement.appendChild(label);
    
    // Resize handles
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(handle => {
        const handleElement = document.createElement('div');
        handleElement.className = `text-box-handle handle-${handle}`;
        handleElement.addEventListener('mousedown', (e) => startResize(e, box, handle));
        boxElement.appendChild(handleElement);
    });
    
    // Box events
    boxElement.addEventListener('mousedown', (e) => startDrag(e, box));
    boxElement.addEventListener('dblclick', () => selectBox(box));
    
    return boxElement;
}

function startDrag(e, box) {
    e.stopPropagation();
    isDragging = true;
    selectedBox = box;
    
    const rect = e.target.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    
    document.addEventListener('mousemove', dragBox);
    document.addEventListener('mouseup', stopDrag);
    
    selectBox(box);
}

function dragBox(e) {
    if (!isDragging || !selectedBox) return;
    
    const overlay = document.getElementById('boxesOverlay');
    const rect = overlay.getBoundingClientRect();
    
    const newX = e.clientX - rect.left - startX;
    const newY = e.clientY - rect.top - startY;
    
    // Update box position
    selectedBox.x = Math.max(0, newX);
    selectedBox.y = Math.max(0, newY);
    
    // Update form
    document.getElementById('boxX').value = Math.round(selectedBox.x);
    document.getElementById('boxY').value = Math.round(selectedBox.y);
    
    renderTextBoxes();
}

function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', dragBox);
    document.removeEventListener('mouseup', stopDrag);
}

function startResize(e, box, handle) {
    e.stopPropagation();
    isResizing = true;
    selectedBox = box;
    
    const startWidth = box.width;
    const startHeight = box.height;
    const startX = box.x;
    const startY = box.y;
    
    const startMouseX = e.clientX;
    const startMouseY = e.clientY;
    
    function resizeBox(e) {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startMouseX;
        const deltaY = e.clientY - startMouseY;
        
        switch (handle) {
            case 'se':
                box.width = Math.max(20, startWidth + deltaX);
                box.height = Math.max(10, startHeight + deltaY);
                break;
            case 'sw':
                box.width = Math.max(20, startWidth - deltaX);
                box.height = Math.max(10, startHeight + deltaY);
                box.x = startX + deltaX;
                break;
            case 'ne':
                box.width = Math.max(20, startWidth + deltaX);
                box.height = Math.max(10, startHeight - deltaY);
                box.y = startY + deltaY;
                break;
            case 'nw':
                box.width = Math.max(20, startWidth - deltaX);
                box.height = Math.max(10, startHeight - deltaY);
                box.x = startX + deltaX;
                box.y = startY + deltaY;
                break;
        }
        
        // Update form
        document.getElementById('boxX').value = Math.round(box.x);
        document.getElementById('boxY').value = Math.round(box.y);
        document.getElementById('boxWidth').value = Math.round(box.width);
        document.getElementById('boxHeight').value = Math.round(box.height);
        
        renderTextBoxes();
    }
    
    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', resizeBox);
        document.removeEventListener('mouseup', stopResize);
    }
    
    document.addEventListener('mousemove', resizeBox);
    document.addEventListener('mouseup', stopResize);
    
    selectBox(box);
}

function selectBox(box) {
    selectedBox = box;
    
    // Update form
    document.getElementById('boxId').value = box.id;
    document.getElementById('boxName').value = box.name;
    document.getElementById('boxX').value = Math.round(box.x);
    document.getElementById('boxY').value = Math.round(box.y);
    document.getElementById('boxWidth').value = Math.round(box.width);
    document.getElementById('boxHeight').value = Math.round(box.height);
    document.getElementById('boxFontSize').value = box.font_size;
    document.getElementById('boxFontFamily').value = box.font_family;
    
    // Show editor
    document.getElementById('boxEditor').style.display = 'block';
    
    // Update boxes list selection
    updateBoxesList();
    renderTextBoxes();
}

function updateSelectedBoxPosition() {
    if (!selectedBox) return;
    
    selectedBox.x = parseInt(document.getElementById('boxX').value) || 0;
    selectedBox.y = parseInt(document.getElementById('boxY').value) || 0;
    
    renderTextBoxes();
}

function updateSelectedBoxSize() {
    if (!selectedBox) return;
    
    selectedBox.width = parseInt(document.getElementById('boxWidth').value) || 50;
    selectedBox.height = parseInt(document.getElementById('boxHeight').value) || 20;
    
    renderTextBoxes();
}

function updateBoxesList() {
    const boxesList = document.getElementById('boxesList');
    
    if (textBoxes.length === 0) {
        boxesList.innerHTML = '<div class="no-boxes">No text boxes yet. Add one to get started!</div>';
        return;
    }
    
    boxesList.innerHTML = textBoxes.map(box => `
        <div class="box-item ${selectedBox && selectedBox.id === box.id ? 'selected' : ''}" 
             onclick="selectBox(${JSON.stringify(box).replace(/"/g, '&quot;')})">
            <div class="box-item-header">
                <span class="box-item-name">${box.name}</span>
                <button class="box-item-delete" onclick="event.stopPropagation(); deleteBox('${box.id}')">×</button>
            </div>
            <div class="box-item-details">
                Position: (${Math.round(box.x)}, ${Math.round(box.y)}) | 
                Size: ${Math.round(box.width)} × ${Math.round(box.height)}
            </div>
        </div>
    `).join('');
}

function updateBoxesCount() {
    document.getElementById('boxesCount').textContent = `(${textBoxes.length})`;
}

function deleteBox(boxId) {
    if (confirm('Are you sure you want to delete this text box?')) {
        textBoxes = textBoxes.filter(box => box.id !== boxId);
        
        if (selectedBox && selectedBox.id === boxId) {
            selectedBox = null;
            document.getElementById('boxEditor').style.display = 'none';
        }
        
        updateBoxesList();
        renderTextBoxes();
    }
}

function deleteCurrentBox() {
    if (selectedBox) {
        deleteBox(selectedBox.id);
    }
}

function clearAllBoxes() {
    if (textBoxes.length === 0) return;
    
    if (confirm('Are you sure you want to delete ALL text boxes?')) {
        textBoxes = [];
        selectedBox = null;
        document.getElementById('boxEditor').style.display = 'none';
        updateBoxesList();
        renderTextBoxes();
    }
}

function saveBox(e) {
    e.preventDefault();
    
    if (!selectedBox) return;
    
    // Update selected box with form data
    selectedBox.name = document.getElementById('boxName').value;
    selectedBox.x = parseInt(document.getElementById('boxX').value) || 0;
    selectedBox.y = parseInt(document.getElementById('boxY').value) || 0;
    selectedBox.width = parseInt(document.getElementById('boxWidth').value) || 50;
    selectedBox.height = parseInt(document.getElementById('boxHeight').value) || 20;
    selectedBox.font_size = parseInt(document.getElementById('boxFontSize').value) || 12;
    selectedBox.font_family = document.getElementById('boxFontFamily').value;
    
    updateBoxesList();
    renderTextBoxes();
    
    alert('Text box updated successfully!');
}

function cancelEdit() {
    selectedBox = null;
    document.getElementById('boxEditor').style.display = 'none';
    updateBoxesList();
    renderTextBoxes();
}

async function saveBoxes() {
    try {
        const response = await fetch(`/api/edit/${currentPdfId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text_boxes: textBoxes
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('All text boxes saved successfully! You can now go to the home page and use the "Fill & Download" button to fill the PDF.');
        } else {
            alert('Error saving text boxes: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving text boxes');
    }
}

function adjustZoom(delta) {
    currentZoom += delta;
    currentZoom = Math.max(50, Math.min(200, currentZoom));
    
    document.getElementById('zoomLevel').textContent = currentZoom + '%';
    
    const pdfFrame = document.getElementById('pdfFrame');
    pdfFrame.style.transform = `scale(${currentZoom / 100})`;
    pdfFrame.style.transformOrigin = 'top left';
    
    // Update boxes overlay
    const boxesOverlay = document.getElementById('boxesOverlay');
    boxesOverlay.style.transform = `scale(${currentZoom / 100})`;
    boxesOverlay.style.transformOrigin = 'top left';
}

// Add CSS for loading animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}